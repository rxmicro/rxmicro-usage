:FRAGMENT_RELATIVE_DIR: ../../../
include::../../../___fragment-settings.adoc[]

:RX-MICRO-USAGE-ROOT-LOCAL-PATH: ../../../../../../../../

===== Features of Testing Postgres Repositories

This section will cover the features of testing REST-based microservices that use postgres repositories.

The source code of such REST-based microservice consists of the `Entity` entity model, `Response` model class, `DataRepository` mongo repository and `MicroService` HTTP request handler:

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/group-testing-junit/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/model/Response.java[tag=content,indent=0]
----

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/group-testing-junit/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/model/Entity.java[tag=content,indent=0]
----

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/group-testing-junit/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/DataRepository.java[tag=content,indent=0]
----

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/group-testing-junit/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/MicroService.java[tag=content,indent=0]
----

The most logical way to test such microservice is to create a mock alternative for the `DataRepository` component:

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/group-testing-junit/testing-microservice-alternatives-postgres-repository/src/test/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/MicroServiceBusinessLogicOnlyTest.java[tag=content,indent=0]
----

But if on the basis of such test we build the source code coverage report, this report will show a low degree of coverage:

.The test coverage report when using a mock alternative for Postgresql repository.
image::testing/microservice/alternative/postgresql-repo/jacoco-business-logic-only.jpg[]

Such a result is caused by the fact that after creating a mock alternative for the `DataRepository` component, the classes generated by the RxMicro framework are not used in the testing process for the postgres repository work.

If such a result is not acceptable, it is necessary to:

. create a mock alternative to the `ConnectionPool` RxMicro component;
. use the static methods of the
{RX-MICRO-SRC-ROOT-BLOB-URL}rxmicro-test-mockito/src/main/java/io/rxmicro/test/mockito/r2dbc/SQLMockFactory.java[`SQLMockFactory`^] class to program the mock behavior.

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/group-testing-junit/testing-microservice-alternatives-postgres-repository/src/test/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/MicroServiceWithAllGeneratedCodeTest.java[tag=content,indent=0]
----

The modified test shows a coverage rate of 100%:

.The test coverage report when using the `ConnectionPool` mock alternative.
image::testing/microservice/alternative/postgresql-repo/jacoco-all-generated.jpg[]

:link: {RX-MICRO-EXAMPLES-SRC-ROOT-TREE-URL}group-testing-junit/testing-microservice-alternatives-postgres-repository
include::../../../___notes/full-source-code-of-example.adoc[]

include::../../../___notes/recompile-after-change.adoc[]
