:FRAGMENT_RELATIVE_DIR: ../../../
include::../../../___fragment-settings.adoc[]

:RX-MICRO-USAGE-ROOT-LOCAL-PATH: ../../../../../../../../

===== Особенности тестирования Postgres репозиториев

В данном разделе будут рассмотрены особенности тестирования REST-based микросервисов, которые используют postgres репозитории.

Исходный код такого REST-based микросервиса состоит из модели сущности `Entity`, класса модели `Response`, postgres репозитория `DataRepository` и обработчика HTTP запросов `MicroService`:

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/model/Response.java[tag=content,indent=0]
----

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/model/Entity.java[tag=content,indent=0]
----

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/DataRepository.java[tag=content,indent=0]
----

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/testing-microservice-alternatives-postgres-repository/src/main/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/MicroService.java[tag=content,indent=0]
----

Самым логичным способом тестирования такого микросервиса является создание альтернативы-мока для компонента `DataRepository`:

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/testing-microservice-alternatives-postgres-repository/src/test/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/MicroServiceBusinessLogicOnlyTest.java[tag=content,indent=0]
----

Однако если на базе такого теста построить отчет по степени покрытия тестами исходного кода проекта, данный отчет покажет слабую степень покрытия:

.Отчет покрытия тестами при использовании альтернативы-мока для Postgresql репозитория.
image::testing/microservice/alternative/postgresql-repo/jacoco-business-logic-only.jpg[]

Такой результат связан с тем, что создав альтернативу-мок для компонента `DataRepository`, в процессе тестирования не используются сгенерированные by the RxMicro framework классы для работы postgres репозитория.

Если такой результат не является допустимым, то необходимо:

. создавать альтернативу-мок RxMicro компоненту `ConnectionPool`;
. использовать статические методы класса
{RX-MICRO-SRC-ROOT-BLOB-URL}rxmicro-test-mockito/src/main/java/io/rxmicro/test/mockito/r2dbc/SQLMockFactory.java[`SQLMockFactory`^] для программирования поведения мока.

[source,java]
----
include::{RX-MICRO-USAGE-ROOT-LOCAL-PATH}examples/testing-microservice-alternatives-postgres-repository/src/test/java/io/rxmicro/examples/testing/microservice/alternatives/postgres/repository/MicroServiceWithAllGeneratedCodeTest.java[tag=content,indent=0]
----

Измененный тест показывает 100% степень покрытия:

.Отчет покрытия тестами при использовании альтернативы-мока `ConnectionPool`.
image::testing/microservice/alternative/postgresql-repo/jacoco-all-generated.jpg[]

:link: {RX-MICRO-EXAMPLES-SRC-ROOT-TREE-URL}testing-microservice-alternatives-postgres-repository
include::../../../___notes/full-source-code-of-example.adoc[]

include::../../../___notes/recompile-after-change.adoc[]
